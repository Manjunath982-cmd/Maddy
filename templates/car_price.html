{% extends 'car_base.html' %}
{% block title %}Used Car Price Prediction{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-4 text-center">Used Car Price Prediction</h2>
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-4">
                <form id="price-form" class="needs-validation" novalidate>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Year</label>
                            <input type="number" name="Year" class="form-control" min="2000" max="{{  now().year }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Present Price (₹ lakhs)</label>
                            <input type="number" step="0.1" name="Present_Price" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kms Driven</label>
                            <input type="number" name="Kms_Driven" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fuel Type</label>
                            <select name="Fuel_Type" class="form-select">
                                <option value="Petrol">Petrol</option>
                                <option value="Diesel">Diesel</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Seller Type</label>
                            <select name="Seller_Type" class="form-select">
                                <option value="Individual">Individual</option>
                                <option value="Dealer">Dealer</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Transmission</label>
                            <select name="Transmission" class="form-select">
                                <option value="Manual">Manual</option>
                                <option value="Automatic">Automatic</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Owner (Count)</label>
                            <input type="number" name="Owner" class="form-control" min="0" max="3" required>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary">Predict Price</button>
                    </div>
                </form>
                <div id="result-area" class="mt-4"></div>
                <div class="text-center mt-3" id="loading" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Bootstrap validation
(function () {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.prototype.slice.call(forms).forEach(function (form) {
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})();

// AJAX submit with spinner
const form = document.getElementById('price-form');
const loading = document.getElementById('loading');
const resultArea = document.getElementById('result-area');

form.addEventListener('submit', function(e){
    e.preventDefault();
    if(!form.checkValidity()) return;

    loading.style.display = 'block';
    resultArea.innerHTML = '';

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    fetch('/predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(json => {
        loading.style.display = 'none';
        if(json.success){
            resultArea.innerHTML = `<div class="alert alert-success text-center">Predicted Selling Price: ₹ ${json.predicted_price} lakhs</div>`;
        } else {
            resultArea.innerHTML = `<div class="alert alert-danger text-center">Error: ${json.error}</div>`;
        }
    })
    .catch(err => {
        loading.style.display = 'none';
        resultArea.innerHTML = `<div class="alert alert-danger text-center">Request failed: ${err}</div>`;
    });
});
</script>
{% endblock %}